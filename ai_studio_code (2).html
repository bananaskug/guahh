<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>axOS Paint</title>
    <style>
        /* --- Basic Setup & Layout --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #333;
            color: #eee;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* --- Toolbar Styling --- */
        #toolbar {
            background-color: #444;
            padding: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            border-bottom: 2px solid #555;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .tool-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .tool-group > label {
            font-size: 0.8em;
            color: #ccc;
            text-align: left;
            margin-bottom: 2px;
        }
        
        .file-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        #filename-input {
            background-color: #2f2f2f;
            border: 1px solid #777;
            color: #fff;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.9em;
            width: 140px;
        }
        
        button, select {
            background-color: #5a5a5a;
            color: #fff;
            border: 1px solid #777;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 1em;
        }

        button:hover, select:hover {
            background-color: #6a6a6a;
        }
        
        #brush-size {
            width: 120px;
        }
        
        #size-display {
             width: 30px;
             text-align: center;
             font-weight: bold;
        }

        /* --- Color Palette --- */
        #color-palette {
            display: grid;
            grid-template-columns: repeat(14, 1fr);
            gap: 3px;
            max-width: 320px;
        }
        
        .color-swatch {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.1s, border-color 0.2s;
        }

        .color-swatch:hover {
            transform: scale(1.1);
        }

        .color-swatch.selected {
            border-color: #fff;
            box-shadow: 0 0 5px #fff;
            transform: scale(1.15);
        }

        /* --- Canvas --- */
        #canvas-container {
            flex-grow: 1;
            position: relative;
            background-color: #282828; /* Checkerboard pattern background */
            background-image:
              linear-gradient(45deg, #3a3a3a 25%, transparent 25%),
              linear-gradient(-45deg, #3a3a3a 25%, transparent 25%),
              linear-gradient(45deg, transparent 75%, #3a3a3a 75%),
              linear-gradient(-45deg, transparent 75%, #3a3a3a 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        #drawing-canvas {
            background-color: #FFFFFF;
            cursor: crosshair;
            display: block; /* Removes bottom space */
        }
    </style>
</head>
<body>

    <div id="app-container">
        <!-- Toolbar for Controls -->
        <div id="toolbar">
            <div class="tool-group">
                <label>File</label>
                <div class="file-controls">
                    <input type="text" id="filename-input" placeholder="drawing.art" value="drawing.art">
                    <button id="save-btn">Save</button>
                    <button id="open-btn">Open</button>
                </div>
            </div>
            
            <div class="tool-group">
                 <label>Canvas</label>
                 <button id="clear-btn">Clear</button>
            </div>
            
            <div class="tool-group">
                 <label>Brush Type</label>
                 <select id="brush-type">
                     <option value="normal">Normal</option>
                     <option value="spray">Spray</option>
                     <option value="ribbon">Ribbon</option>
                     <option value="eraser">Eraser</option>
                 </select>
            </div>
            
            <div class="tool-group">
                <label>Thickness (<span id="size-display">5</span>px)</label>
                <input type="range" id="brush-size" min="1" max="100" value="5">
            </div>
            
            <div class="tool-group">
                <label>Color</label>
                <div id="color-palette"></div>
            </div>
        </div>

        <!-- Drawing Area -->
        <main id="canvas-container">
            <canvas id="drawing-canvas"></canvas>
        </main>
    </div>

    <script>
        // --- axOS API for Apps ---

        const fileSystemCallbacks = {};
        let messageId = 0;

        /**
         * Asks the main OS to show a system dialog box.
         * @param {string} message - The message to display in the pop-up.
         */
        function showOSDialog(message) {
            parent.postMessage({
                type: 'axOS_showDialog',
                payload: { message }
                // No ID or callback needed for a simple notification
            }, '*');
        }

        /**
         * Saves content to a file in the axOS VFS.
         * @param {string} filename - The name of the file (e.g., 'data.json').
         * @param {string} content - The content to save.
         * @param {function} callback - A function to call with the result.
         */
        function saveFile(filename, content, callback) {
            const id = messageId++;
            fileSystemCallbacks[id] = callback;
            parent.postMessage({ type: 'axOS_saveFile', payload: { filename, content }, id: id }, '*');
        }

        /**
         * Loads content from a file in the axOS VFS.
         * @param {string} filename - The name of the file to load.
         * @param {function} callback - A function to call with the file's content.
         */
        function loadFile(filename, callback) {
            const id = messageId++;
            fileSystemCallbacks[id] = callback;
            parent.postMessage({ type: 'axOS_loadFile', payload: { filename }, id: id }, '*');
        }
        
        /**
         * Deletes a file from the axOS VFS.
         * @param {string} filename - The name of the file to delete.
         * @param {function} callback - A function to call with the result.
         */
        function deleteFile(filename, callback) {
            const id = messageId++;
            fileSystemCallbacks[id] = callback;
            parent.postMessage({ type: 'axOS_deleteFile', payload: { filename }, id: id }, '*');
        }

        // Listen for messages coming back from the OS
        window.addEventListener('message', (event) => {
            const { type, payload, id } = event.data;
            if (fileSystemCallbacks[id]) {
                fileSystemCallbacks[id](payload); 
                delete fileSystemCallbacks[id]; 
            }
        });

        // --- Paint Application Logic ---

        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('drawing-canvas');
            const ctx = canvas.getContext('2d');
            const canvasContainer = document.getElementById('canvas-container');

            // --- State Variables ---
            let isDrawing = false;
            let currentColor = '#FF0000';
            let brushSize = 5;
            let currentBrush = 'normal';
            let lastX = 0;
            let lastY = 0;

            // --- UI Element References ---
            const filenameInput = document.getElementById('filename-input');
            const saveBtn = document.getElementById('save-btn');
            const openBtn = document.getElementById('open-btn');
            const clearBtn = document.getElementById('clear-btn');
            const brushSizeSlider = document.getElementById('brush-size');
            const sizeDisplay = document.getElementById('size-display');
            const brushTypeSelector = document.getElementById('brush-type');
            const colorPaletteContainer = document.getElementById('color-palette');
            
            // --- Color Palette Setup ---
            const colors = [
                '#FFFFFF', '#C1C1C1', '#858585', '#555555', '#2A2A2A', '#000000', '#007bff', '#19a974',
                '#FF0000', '#FF7F00', '#FFFF00', '#00FF00', '#0000FF', '#4B0082', '#9400D3', '#e81cff',
                '#ff4136', '#ff851b', '#ffdc00', '#2ecc40', '#7fdbff', '#b10dc9', '#f012be', '#39cccc',
                '#f56565', '#ed8936', '#ecc94b', '#48bb78', '#4299e1', '#9f7aea', '#ed64a6', '#a0aec0'
            ];
            colors.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = color;
                if (color === currentColor) swatch.classList.add('selected');
                swatch.addEventListener('click', () => {
                    currentColor = color;
                    document.querySelector('.color-swatch.selected')?.classList.remove('selected');
                    swatch.classList.add('selected');
                });
                colorPaletteContainer.appendChild(swatch);
            });

            // --- Canvas Sizing and Management ---
            function resizeCanvas() {
                // Save current canvas state
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                // Resize
                canvas.width = canvasContainer.clientWidth;
                canvas.height = canvasContainer.clientHeight;
                // Restore saved state
                ctx.putImageData(imageData, 0, 0);
            }

            function clearCanvas(confirm = true) {
                if (confirm && !window.confirm('Are you sure you want to clear the canvas? This cannot be undone.')) {
                    return;
                }
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            window.addEventListener('resize', resizeCanvas);
            clearCanvas(false); // Start with a blank white canvas

            // --- Drawing Logic ---
            function getCoords(e) {
                const rect = canvas.getBoundingClientRect();
                const event = e.touches ? e.touches[0] : e;
                return [event.clientX - rect.left, event.clientY - rect.top];
            }

            function startDrawing(e) {
                e.preventDefault();
                isDrawing = true;
                [lastX, lastY] = getCoords(e);
            }
            
            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                const [currentX, currentY] = getCoords(e);
                ctx.lineWidth = brushSize;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.globalCompositeOperation = (currentBrush === 'eraser') ? 'destination-out' : 'source-over';
                ctx.strokeStyle = (currentBrush === 'eraser') ? 'rgba(0,0,0,1)' : currentColor;
                ctx.fillStyle = currentColor;
                
                switch(currentBrush) {
                    case 'spray':
                        for (let i = brushSize * 2; i--; ) {
                            const radius = brushSize / 2;
                            const offsetX = (Math.random() - 0.5) * brushSize;
                            const offsetY = (Math.random() - 0.5) * brushSize;
                            if (Math.sqrt(offsetX*offsetX + offsetY*offsetY) <= radius) {
                                ctx.fillRect(currentX + offsetX, currentY + offsetY, 1, 1);
                            }
                        }
                        break;
                    case 'ribbon':
                        ctx.beginPath();
                        ctx.moveTo(lastX - brushSize / 4, lastY - brushSize / 4);
                        ctx.lineTo(currentX - brushSize / 4, currentY - brushSize / 4);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(lastX + brushSize / 4, lastY + brushSize / 4);
                        ctx.lineTo(currentX + brushSize / 4, currentY + brushSize / 4);
                        ctx.stroke();
                        break;
                    default: // normal, eraser
                        ctx.beginPath();
                        ctx.moveTo(lastX, lastY);
                        ctx.lineTo(currentX, currentY);
                        ctx.stroke();
                        break;
                }
                [lastX, lastY] = [currentX, currentY];
            }

            function stopDrawing() { isDrawing = false; ctx.beginPath(); }

            // --- Event Listeners ---
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseleave', stopDrawing);
            canvas.addEventListener('touchstart', startDrawing, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);
            
            clearBtn.addEventListener('click', () => clearCanvas(true));
            brushSizeSlider.addEventListener('input', (e) => (sizeDisplay.textContent = brushSize = e.target.value));
            brushTypeSelector.addEventListener('change', (e) => (currentBrush = e.target.value));
            
            // --- File Operations ---
            const getValidatedFilename = () => {
                let filename = filenameInput.value.trim();
                if (!filename) {
                    showOSDialog("Please enter a filename.");
                    return null;
                }
                if (!filename.toLowerCase().endsWith('.art')) {
                    filename += '.art';
                }
                return filename;
            };
            
            saveBtn.addEventListener('click', () => {
                const filename = getValidatedFilename();
                if (filename) {
                    const dataURL = canvas.toDataURL('image/png');
                    saveFile(filename, dataURL, (response) => {
                        if (response.success) {
                            showOSDialog(`'${filename}' saved successfully!`);
                        } else {
                            showOSDialog(`Error saving file: ${response.error}`);
                        }
                    });
                }
            });
            
            openBtn.addEventListener('click', () => {
                const filename = getValidatedFilename();
                if (filename) {
                    loadFile(filename, (response) => {
                        if (response.success && response.content) {
                            const img = new Image();
                            img.onload = () => {
                                clearCanvas(false);
                                // Draw centered and scaled to fit without stretching
                                const canvasRatio = canvas.width / canvas.height;
                                const imgRatio = img.width / img.height;
                                let w, h, x, y;
                                if (imgRatio > canvasRatio) { // Image is wider
                                    w = canvas.width;
                                    h = canvas.width / imgRatio;
                                } else { // Image is taller or same ratio
                                    h = canvas.height;
                                    w = canvas.height * imgRatio;
                                }
                                x = (canvas.width - w) / 2;
                                y = (canvas.height - h) / 2;
                                ctx.drawImage(img, x, y, w, h);
                                showOSDialog(`'${filename}' opened.`);
                            };
                            img.onerror = () => showOSDialog(`Could not load image data from '${filename}'. File may be corrupt.`);
                            img.src = response.content;
                        } else {
                            showOSDialog(`Error opening file: ${response.error || "File not found."}`);
                        }
                    });
                }
            });
        });
    </script>
</body>
</html>