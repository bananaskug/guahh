<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guahh Text</title>
    <!-- GOOGLE FONTS IMPORT -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato&family=Montserrat&family=Open+Sans&family=Roboto&display=swap" rel="stylesheet">
    <style>
        :root {
            --page-width: 210mm; --page-height: 297mm; --page-padding: 1in;
            --page-bg: #FFFFFF; --editor-bg: #EAEFF5; --toolbar-bg: #FFFFFF; --primary-accent: #0D6EFD;
            --border-color: #DEE2E6; --strong-border-color: #ADB5BD; --text-color: #212529; --button-size: 36px;
        }
        body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--editor-bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* --- Toolbar --- */
        #toolbar { display: flex; flex-wrap: wrap; align-items: center; padding: 8px 10px; background-color: var(--toolbar-bg); border-bottom: 1px solid var(--border-color); z-index: 1000; gap: 5px; flex-shrink: 0; }
        #toolbar .tool-group { display: flex; align-items: center; border-right: 1px solid var(--border-color); padding-right: 8px; margin-right: 3px; }
        #toolbar button, #toolbar label { width: var(--button-size); height: var(--button-size); background: transparent; border: 1px solid transparent; border-radius: 0; cursor: pointer; padding: 0; margin: 0; display: inline-flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; transition: background-color 0.15s ease; }
        #toolbar .tool-group:last-of-type { border-right: none; }
        #toolbar select { height: var(--button-size); background: #FFFFFF; border: 1px solid var(--border-color); border-radius: 0; margin: 0; display: flex; align-items: center; cursor: pointer; padding: 0 8px; font-size: 14px; }
        #toolbar #font-family-selector { max-width: 150px; }
        #toolbar #font-size-selector { width: 85px; }
        #toolbar .input-wrapper { height: var(--button-size); background: #FFFFFF; border: 1px solid var(--border-color); border-radius: 0; margin: 0; display: flex; align-items: center; }
        #toolbar input { height: 100%; border: none; text-align: left; font-size: 14px; padding: 0 8px; outline: none; background: transparent;}
        #doc-name-input { width: 200px; }
        #toolbar button:hover, #toolbar label:hover, #toolbar select:hover, #toolbar .input-wrapper:hover { background-color: #e9ecef; }
        #toolbar button.active { background-color: #dbeafe; }
        #toolbar .color-picker-wrapper { width: var(--button-size); height: var(--button-size); border: 1px solid var(--border-color); padding: 3px; box-sizing: border-box; }
        #toolbar input[type="color"] { width: 100%; height: 100%; border: none; padding: 0; cursor: pointer; }
        #imageUpload { display: none; }

        /* --- Editor Area & Paging System --- */
        #editor-area { flex-grow: 1; overflow-y: auto; padding: 40px; }
        #page-container { display: flex; flex-direction: column; align-items: center; gap: 40px; transform-origin: top center; transition: transform 0.2s ease-out; }
        .page { width: var(--page-width); min-height: var(--page-height); max-height: var(--page-height); background-color: var(--page-bg); border: 1px solid var(--strong-border-color); box-shadow: 0 2px 10px rgba(0,0,0,0.1); box-sizing: border-box; padding: var(--page-padding); position: relative; overflow: hidden; flex-shrink: 0; }
        .page .editor-content { outline: none; height: 100%; }

        /* --- Image Layer & Controls (condensed) --- */
        .image-layer { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 2; pointer-events: none; }
        .image-container { position: absolute; cursor: move; pointer-events: auto; border: 2px solid transparent; background-color: white; }
        .image-container.selected { border-color: var(--primary-accent); z-index: 50 !important; }
        .image-container img { display: block; width: 100%; height: 100%; user-select: none; }
        .resizer { width: 12px; height: 12px; background: var(--page-bg); border: 2px solid var(--primary-accent); position: absolute; right: -8px; bottom: -8px; cursor: se-resize; display: none; }
        .image-controls { position: absolute; top: -35px; left: 50%; transform: translateX(-50%); background: #343a40; padding: 2px; display: none; gap: 2px; border-radius: 0; }
        .image-controls button { background: transparent; color: white; border: none; padding: 4px; font-size: 18px; line-height: 1; }
        .image-controls button:hover { background: #495057; }
        .image-container.selected .resizer, .image-container.selected .image-controls { display: flex; }

        /* Status bar for zoom controls */
        #status-bar { flex-shrink: 0; background-color: var(--toolbar-bg); border-top: 1px solid var(--border-color); padding: 4px 15px; display: flex; align-items: center; justify-content: flex-end; gap: 10px; z-index: 1001; }
        #status-bar button { background: none; border: 1px solid transparent; border-radius: 3px; font-size: 18px; line-height: 1; padding: 2px 8px; cursor: pointer; }
        #status-bar button:hover { background-color: #e9ecef; border-color: #ced4da; }
        #status-bar #zoom-level { font-size: 14px; font-weight: bold; color: #495057; width: 50px; text-align: center; }
    </style>
</head>
<body>
    <div id="toolbar">
        <div class="tool-group">
            <div class="input-wrapper"><input type="text" id="doc-name-input" title="Document Name"></div>
            <select id="doc-selector" title="Load a Document"></select>
            <button id="new-doc-btn" title="New Document">‚ûï</button>
            <button id="download-doc-btn" title="Download Document Backup">üíæ</button>
            <button id="delete-doc-btn" title="Delete Current Document">üóëÔ∏è</button>
        </div>
        <div class="tool-group">
            <button onclick="execCmd('undo')" title="Undo">‚Ü©Ô∏è</button><button onclick="execCmd('redo')" title="Redo">‚Ü™Ô∏è</button>
        </div>
        <div class="tool-group">
            <select id="font-family-selector" onchange="execCmd('fontName', this.value)" title="Font">
                <option value="Arial">Arial</option><option value="Verdana">Verdana</option><option value="Times New Roman">Times New Roman</option>
                <option value="Roboto" style="font-family:'Roboto',sans-serif">Roboto</option><option value="Lato" style="font-family:'Lato',sans-serif">Lato</option>
                <option value="Open Sans" style="font-family:'Open Sans',sans-serif">Open Sans</option><option value="Montserrat" style="font-family:'Montserrat',sans-serif">Montserrat</option>
            </select>
            <select id="font-size-selector" onchange="applyFontSize(this.value)" title="Font Size">
                <option value="8">8 pt</option><option value="10">10 pt</option><option value="11">11 pt</option>
                <option value="12">12 pt</option><option value="14">14 pt</option><option value="16">16 pt</option>
                <option value="18">18 pt</option><option value="24">24 pt</option><option value="36">36 pt</option>
                <option value="48">48 pt</option><option value="72">72 pt</option><option value="96">96 pt</option>
            </select>
        </div>
        <div class="tool-group"><button onclick="execCmd('bold')" title="Bold"><b>B</b></button><button onclick="execCmd('italic')" title="Italic"><i>I</i></button><button onclick="execCmd('underline')" title="Underline"><u>U</u></button><button onclick="execCmd('strikethrough')" title="Strikethrough"><s>S</s></button></div>
        <div class="tool-group"><div class="color-picker-wrapper" title="Text Color"><input type="color" oninput="execCmd('foreColor', this.value)" value="#000000"></div><div class="color-picker-wrapper" title="Highlight Color"><input type="color" oninput="execCmd('hiliteColor', this.value)" value="#FFFFFF"></div></div>
        <div class="tool-group"><button onclick="execCmd('justifyLeft')" title="Align Left">L</button><button onclick="execCmd('justifyCenter')" title="Align Center">C</button><button onclick="execCmd('justifyRight')" title="Align Right">R</button><button onclick="execCmd('justifyFull')" title="Justify">J</button></div>
        <div class="tool-group"><button onclick="execCmd('insertUnorderedList')" title="Bulleted List">‚Ä¢‚Ä¢‚Ä¢</button><button onclick="execCmd('insertOrderedList')" title="Numbered List">1.</button><button onclick="execCmd('outdent')" title="Decrease Indent">‚á•</button><button onclick="execCmd('indent')" title="Increase Indent">‚Ü¶</button></div>
        <!-- FIX: Link button removed as requested -->
        <div class="tool-group"><button onclick="execCmd('insertHorizontalRule')" title="Insert Horizontal Rule" style="font-weight: normal; letter-spacing: -2px;">---</button><button onclick="execCmd('formatBlock', 'blockquote')" title="Blockquote">‚ùù</button><label for="imageUpload" title="Insert Image" style="font-size:20px;">üñºÔ∏è</label><input type="file" id="imageUpload" accept="image/*" onchange="insertImageFile(event)"><button onclick="execCmd('removeFormat')" title="Clear Formatting">üßº</button></div>
    </div>
    <main id="editor-area"><div id="page-container"></div></main>
    <div id="status-bar">
        <button id="zoom-out-btn" title="Zoom Out">-</button>
        <span id="zoom-level" title="Current Zoom">100%</span>
        <button id="zoom-in-btn" title="Zoom In">+</button>
        <button id="zoom-reset-btn" title="Reset Zoom">Reset</button>
    </div>

    <script>
        const pageContainer = document.getElementById('page-container');
        const docNameInput = document.getElementById('doc-name-input');
        const docSelector = document.getElementById('doc-selector');
        const LOCALSTORAGE_KEY = 'guahh_text_saves_v5';
        let zIndexCounter = 10, activeEditor = null, activeDocId = null, debounceTimeout = null, currentZoom = 1.0;

        // --- SAVE/LOAD SYSTEM ---
        function triggerAutoSave() { clearTimeout(debounceTimeout); debounceTimeout = setTimeout(() => saveStateToBrowser(), 1500); }
        function getFileList() { return JSON.parse(localStorage.getItem(LOCALSTORAGE_KEY) || '[]'); }
        function saveFileList(fileList) { localStorage.setItem(LOCALSTORAGE_KEY, JSON.stringify(fileList)); }
        function populateDocSelector() { const fL = getFileList(); const currentVal = activeDocId; docSelector.innerHTML = ''; fL.forEach(d => { const o = new Option(d.name, d.id); docSelector.add(o); }); docSelector.value = currentVal || ""; }
        function saveStateToBrowser() {
            if (!activeDocId) return;
            const dN = docNameInput.value.trim() || 'Untitled'; let fL = getFileList(); let dM = fL.find(d => d.id === activeDocId);
            if (dM) { dM.name = dN; } else { fL.push({ id: activeDocId, name: dN }); }
            saveFileList(fL); populateDocSelector();
            const pD = Array.from(pageContainer.querySelectorAll('.page')).map(p => ({ editorHTML: p.querySelector('.editor-content').innerHTML, imageLayerHTML: p.querySelector('.image-layer').innerHTML }));
            localStorage.setItem(`${LOCALSTORAGE_KEY}_${activeDocId}`, JSON.stringify({ name: dN, pages: pD }));
        }
        function downloadBackup() {
            if (!activeDocId) { alert("No active document to download."); return; }
            saveStateToBrowser(); const dN = docNameInput.value.trim() || 'Untitled'; const dS = localStorage.getItem(`${LOCALSTORAGE_KEY}_${activeDocId}`);
            if(!dS) { alert("Document data not found."); return; }
            const blob = new Blob([dS], {type: 'application/json'}); const a = document.createElement('a');
            a.href = URL.createObjectURL(blob); a.download = `${dN}.guahh.json`; a.click(); URL.revokeObjectURL(a.href);
        }
        function loadDocument(docId) {
            const docString = localStorage.getItem(`${LOCALSTORAGE_KEY}_${docId}`); if (!docString) { console.error(`Doc ID not found: ${docId}`); return; }
            const docData = JSON.parse(docString); pageContainer.innerHTML = '';
            if (docData.pages && docData.pages.length > 0) {
                docData.pages.forEach(pageData => { const newEditor = addNewPage(); const newPage = newEditor.parentElement; newPage.querySelector('.editor-content').innerHTML = pageData.editorHTML; const imageLayer = newPage.querySelector('.image-layer'); imageLayer.innerHTML = pageData.imageLayerHTML; imageLayer.querySelectorAll('.image-container').forEach(c => { const i = c.querySelector('img'); if (i.complete) makeInteractive(c, i.naturalWidth / i.naturalHeight); else i.onload = () => makeInteractive(c, i.naturalWidth / i.naturalHeight); }); });
            } else { addNewPage(true); }
            activeDocId = docId; const docMeta = getFileList().find(d => d.id === docId);
            docNameInput.value = docMeta ? docMeta.name : "Untitled";
            docSelector.value = docId; localStorage.setItem(`${LOCALSTORAGE_KEY}_last_active`, docId);
            if (pageContainer.firstChild) { activeEditor = pageContainer.firstChild.querySelector('.editor-content'); activeEditor.focus(); }
            checkAllPages(); updateToolbar();
        }
        function createNewDocument() { pageContainer.innerHTML = ''; activeDocId = Date.now().toString(); const newName = `Untitled ${getFileList().length + 1}`; docNameInput.value = newName; activeEditor = addNewPage(true); saveStateToBrowser(); }
        function deleteCurrentDocument() {
            if (!activeDocId) { alert("No document selected to delete."); return; }
            if (confirm(`Are you sure you want to permanently delete "${docNameInput.value}"? This cannot be undone.`)) {
                const docIdToDelete = activeDocId;
                let fileList = getFileList().filter(doc => doc.id !== docIdToDelete);
                localStorage.removeItem(`${LOCALSTORAGE_KEY}_${docIdToDelete}`); localStorage.removeItem(`${LOCALSTORAGE_KEY}_last_active`);
                saveFileList(fileList); populateDocSelector();
                if (fileList.length > 0) { loadDocument(fileList[0].id); } else { createNewDocument(); }
            }
        }

        // --- COMMANDS & SELECTION ---
        function execCmd(command, value = null) { document.execCommand(command, false, value); if(activeEditor) activeEditor.focus(); updateToolbar(); triggerAutoSave(); }
        
        // FIX: The createLink function has been removed.

        // FIX: `applyFontSize` now more safely wraps content and calls updateToolbar immediately.
        function applyFontSize(size) {
            if (!size || !activeEditor) return;
            const span = document.createElement('span');
            span.style.fontSize = `${size}pt`;
            
            const sel = window.getSelection();
            if (!sel.rangeCount) return;
            const range = sel.getRangeAt(0);
            
            if (range.collapsed) {
                range.insertNode(span);
                const newRange = document.createRange();
                newRange.selectNodeContents(span);
                newRange.collapse(false); // to the end
                sel.removeAllRanges();
                sel.addRange(newRange);
            } else {
                try {
                    range.surroundContents(span);
                } catch(e) {
                    console.error("Could not surround contents, using fallback.", e);
                }
            }
            activeEditor.focus();
            triggerAutoSave();
            updateToolbar(); // Ensure UI updates instantly
        }
        
        // --- MULTI-PAGE & IMAGE SYSTEMS (Condensed) ---
        function addNewPage(f=false){const p=document.createElement('div');p.className='page';p.innerHTML=`<div class="image-layer"></div><div class="editor-content" contenteditable="true"></div>`;pageContainer.appendChild(p);const e=p.querySelector('.editor-content');e.addEventListener('input',()=>handleInput(e));e.addEventListener('focus',()=> { activeEditor = e; updateToolbar(); });e.addEventListener('paste', e => { e.preventDefault(); const text = e.clipboardData.getData('text/plain'); document.execCommand('insertText', false, text); }); if(f){activeEditor=e;e.focus();}return e;}
        let isChecking=false;function handleInput(e){if(isChecking)return;triggerAutoSave();isChecking=true;requestAnimationFrame(()=>{checkPageOverflow(e);isChecking=false;});updateToolbar();}
        function checkAllPages(){pageContainer.querySelectorAll('.editor-content').forEach(e=>checkPageOverflow(e));}
        function checkPageOverflow(cE){const cP=cE.parentElement;while(cP.scrollHeight>cP.clientHeight){let nP=cP.nextElementSibling;if(!nP){nP=addNewPage().parentElement;}const nE=nP.querySelector('.editor-content'),lN=cE.lastChild;if(lN)nE.insertBefore(lN,nE.firstChild);else break;}if(cP.previousElementSibling){const pP=cP.previousElementSibling,pE=pP.querySelector('.editor-content');while(pP.scrollHeight<pP.clientHeight-20){const fN=cE.firstChild;if(fN)pE.appendChild(fN);else break;}}const pages=Array.from(pageContainer.children);for(let i=0;i<pages.length-1;i++){const p=pages[i];if(!p.querySelector('.editor-content').hasChildNodes()&&!p.querySelector('.image-layer').hasChildNodes())p.remove();}}
        function insertImageFile(e){if(!activeEditor){alert("Click on a page first to select where to add the image.");return;}const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=(evt)=>createImageContainer(evt.target.result);r.readAsDataURL(f);e.target.value=null;}
        function createImageContainer(s){const p=activeEditor.parentElement,iL=p.querySelector('.image-layer'),c=document.createElement('div');c.className='image-container';c.style.top=`${activeEditor.scrollTop+50}px`;c.style.left=`50px`;c.style.width='200px';c.style.zIndex=zIndexCounter++;const i=document.createElement('img');i.src=s;i.onload=()=>makeInteractive(c,i.naturalWidth/i.naturalHeight);c.innerHTML=`<div class="resizer"></div><div class="image-controls"><button onclick="changeZIndex(this,'up')">üîº</button><button onclick="changeZIndex(this,'down')">üîΩ</button><button onclick="deleteImage(this)">üóëÔ∏è</button></div>`;c.insertBefore(i,c.firstChild);iL.appendChild(c);selectImage(c);triggerAutoSave();}
        function makeInteractive(e,ar){let isD=false,isR=false,iX,iY,iW,iH,xO,yO;e.addEventListener('mousedown',(evt)=>{if(evt.target.closest('.resizer')){isR=true;iX=evt.clientX;iY=evt.clientY;iW=e.offsetWidth;iH=e.offsetHeight;}else if(!evt.target.closest('.image-controls')){isD=true;e.style.zIndex=zIndexCounter++;xO=evt.clientX-e.offsetLeft;yO=evt.clientY-e.offsetTop;}selectImage(e);document.addEventListener('mousemove',onMove);document.addEventListener('mouseup',onUp,{once:true});evt.preventDefault();});function onMove(evt){if(isR){const dx=evt.clientX-iX;const w = iW + dx; e.style.width=`${w}px`;e.style.height=`${w/ar}px`;}else if(isD){e.style.left=`${evt.clientX-xO}px`;e.style.top=`${evt.clientY-yO}px`;}}function onUp(){triggerAutoSave();isD=false;isR=false;document.removeEventListener('mousemove',onMove);}}
        function selectImage(t){document.querySelectorAll('.image-container.selected').forEach(e=>e.classList.remove('selected'));if(t)t.classList.add('selected');}
        window.changeZIndex=(b,d)=>{const z=parseInt(b.closest('.image-container').style.zIndex||'10');b.closest('.image-container').style.zIndex=d==='up'?(z+1):Math.max(0,z-1);triggerAutoSave();};window.deleteImage=(b)=>{b.closest('.image-container').remove();triggerAutoSave();};
        
        // --- TOOLBAR & LISTENERS ---
        // FIX: Re-written to be more robust. Uses getComputedStyle to find the *actual* style at the cursor.
        function updateToolbar() {
            ['bold','italic','underline','strikethrough','justifyLeft','justifyCenter','justifyRight','justifyFull','insertUnorderedList','insertOrderedList'].forEach(cmd=>{const btn=document.querySelector(`button[onclick*="${cmd}"]`);if(btn)btn.classList.toggle('active',document.queryCommandState(cmd));});
            const sel = window.getSelection();
            if (!sel.rangeCount || !activeEditor || !sel.anchorNode) return;
            
            const element = (sel.anchorNode.nodeType === 3 ? sel.anchorNode.parentElement : sel.anchorNode);
            const style = window.getComputedStyle(element);
            
            const fontFamilySelector = document.getElementById('font-family-selector');
            const rawFontFamily = style.fontFamily.split(',')[0].replace(/["']/g, '').trim();
            fontFamilySelector.value = rawFontFamily;

            const fontSizeSelector = document.getElementById('font-size-selector');
            const fontSizePx = parseFloat(style.fontSize);
            const fontSizePt = Math.round(fontSizePx * 0.75); // Convert px to pt (1px = 0.75pt)
            fontSizeSelector.value = fontSizePt;
        }

        // --- Zoom functions ---
        function applyZoom() {
            pageContainer.style.transform = `scale(${currentZoom})`;
            document.getElementById('zoom-level').textContent = `${Math.round(currentZoom * 100)}%`;
        }
        
        // --- Event Listeners ---
        document.addEventListener('selectionchange', updateToolbar);
        // FIX: Added keyup listener to catch style changes when navigating with arrow keys.
        document.addEventListener('keyup', updateToolbar);
        document.addEventListener('mousedown',(e)=>{if(!e.target.closest('.image-container')&&!e.target.closest('#toolbar')){selectImage(null);}});
        docNameInput.addEventListener('input', triggerAutoSave);
        docNameInput.addEventListener('blur', saveStateToBrowser);
        document.getElementById('download-doc-btn').addEventListener('click', downloadBackup);
        docSelector.addEventListener('change', (e) => { if(e.target.value) loadDocument(e.target.value); });
        document.getElementById('new-doc-btn').addEventListener('click', createNewDocument);
        document.getElementById('delete-doc-btn').addEventListener('click', deleteCurrentDocument);
        document.getElementById('zoom-in-btn').addEventListener('click', () => { currentZoom = Math.min(2.0, currentZoom + 0.1); applyZoom(); });
        document.getElementById('zoom-out-btn').addEventListener('click', () => { currentZoom = Math.max(0.3, currentZoom - 0.1); applyZoom(); });
        document.getElementById('zoom-reset-btn').addEventListener('click', () => { currentZoom = 1.0; applyZoom(); });

        // --- INITIALIZE ---
        document.addEventListener('DOMContentLoaded',()=>{
            populateDocSelector();
            const lastActiveId = localStorage.getItem(`${LOCALSTORAGE_KEY}_last_active`);
            if(lastActiveId && getFileList().some(f => f.id === lastActiveId)) { loadDocument(lastActiveId); }
            else if (getFileList().length > 0) { loadDocument(getFileList()[0].id); }
            else { createNewDocument(); }
            updateToolbar();
        });
    </script>
</body>
</html>